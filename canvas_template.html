<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Scatterplot with D3 and Canvas</title>
    <style>
        #root {
            margin: auto;
        }

        #axisLayer {
            position: absolute;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
</head>

<body>
</body>

<script>
    // Create a container <div> in the body
    const container = d3.select("body")
        .append("div")
        .attr("id", "chart-container")
        .style("width", "1000px")
        .style("margin", "20px auto");

    // Objec to store y-scales for each dimension
    const yScales = {};

    // Define the dimensions of the chart
    const dimensions = ["sepal.length", "sepal.width", "petal.length", "petal.width"];

    // Define the width and height of the chart
    const width = 800;
    const height = 500;

    // scalePoint for the x axis
    const xScale = d3.scalePoint()
        .domain(dimensions)
        .range([0, width]);

    // Define the color scale
    const colorScale = d3.scaleOrdinal()
        .domain(["setosa", "versicolor", "virginica"])
        .range(["#E32636", "#5072A7", "#4CBB17"]);

    //tooltip container (hidden initially)
    const tooltip = container
        .append("div")
        .style("position", "absolute")
        .style("background", "#ffffff")
        .style("border", "1px solid black")
        .style("padding", "4px 8px")
        .style("border-radius", "4px")
        .style("pointer-events", "none")
        .style("opacity", 0);


    const size = {
        width: 1000,
        height: 600,
        margin: 50
    }
    let select = '';

    // margin: auto in CSS is used to put the root div in the center
    const root = d3.select('body').append('div')
        .attr('id', 'root')
        .style('width', `${size.width}px`)
        .style('height', `${size.height}px`);

    // position: absolute in CSS is used to overlap the svg on top of the canvas
    const svg = root.append('svg')
        .attr('id', 'axisLayer')
        .attr('width', size.width)
        .attr('height', size.height);

    // the canvas has the same size as the svg, they are both positioned in the same place, so we can draw on the canvas and overlay the axes on top of it
    const canvas = root.append('canvas')
        .attr('id', 'linesLayer')
        .attr('width', size.width)
        .attr('height', size.height);
    const context = canvas.node().getContext("2d");     // please note the variable canvas is a d3 selection, but we need the DOM node to get the context

    d3.csv('./iris.csv')
        .then(data => {
            // declare necessary scales, such as dimension scale, value scale, and color scale.
            yScales["sepal.length"] = d3.scaleLinear()
                .domain([4, 8])
                .range([height, 0]);

            yScales["sepal.width"] = d3.scaleLinear()
                .domain([2, 4.5])
                .range([height, 0]);

            yScales["petal.length"] = d3.scaleLinear()
                .domain([1, 7])
                .range([height, 0]);

            yScales["petal.width"] = d3.scaleLinear()
                .domain([0, 2.5])
                .range([height, 0]);
            // add x-axis and four y-axes to the svg
            // x-axis
            const xAxis = d3.axisBottom(xScale)
                .tickValues(dimensions);  // Manually set tick values to match dimensions

            const g = mainGroup.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(0, ${height})`)
                .call(xAxis)
                .selectAll("text")
                .style("text-anchor", "end" + 10);

            // y-axis
            dimensions.forEach(dim => {
                let tickValues;

                // Manually define tick values for each axis to match 
                if (dim === "sepal.length") {
                    tickValues = [5, 6, 7];
                } else if (dim === "sepal.width") {
                    tickValues = [2.0, 3.0, 4.0];
                } else if (dim === "petal.length") {
                    tickValues = [1, 2, 3, 4, 5, 6];
                } else if (dim === "petal.width") {
                    tickValues = [1, 2];
                }

                const yAxis = d3.axisLeft(yScales[dim])
                    .tickValues(tickValues)  // Set tick values manually
                    .tickFormat(d3.format(".1f"));  // Format numbers properly

                const g = mainGroup.append("g")
                    .attr("class", `y-axis y-axis-${dim}`)
                    .attr("transform", `translate(${xScale(dim)}, 0)`)
                    .call(yAxis);
            });

            // add color legend for variety to svg, define the click event to filter the selection
            const legendGroup = svg.append("g")
                .attr("transform", `translate(${width + 100}, 50)`);  // Adjust for top right placement

            const legendData = colorScale.domain();
            legendData.forEach((species, i) => {
                const legendItem = legendGroup.append("g")
                    .attr("transform", `translate(0, ${i * 25})`);

                // Color box
                legendItem.append("rect")
                    .attr("x", 50)
                    .attr("y", 0)
                    .attr("width", 40)
                    .attr("height", 20)
                    .attr("fill", colorScale(species));

                // Text label
                legendItem.append("text")
                    .attr("x", -15)
                    .attr("y", 14)
                    .attr("font-size", "14px")
                    .attr("fill", "black")
                    .text(species);
            });
            // define a function to render the lines according to the selected variety
            // draw the lines on the canvas

            function renderLines() {
                context.clearRect(0, 0, width, height);

                data.forEach(d => {
                    context.beginPath();
                    context.moveTo(xScale(dimensions[0]), yScales[dimensions[0]](d[dimensions[0]]));

                    dimensions.forEach((dim, i) => {
                        if (i > 0) {
                            context.lineTo(xScale(dim), yScales[dim](d[dim]));
                        }
                    });

                    context.strokeStyle = colorScale(d.variety);
                    context.stroke();
                });
            }
        })
</script>

</html>